!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.zasi=e():t.zasi=e()}(window,function(){return function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){t.exports=i(1)},function(t,e,i){"use strict";i.r(e);const s=1e-5,r=2*Math.PI,l=Math.PI/180,h=180/Math.PI;class n{static overlaps(t,e){let i=t,s=e;return i.left<=s.right&&i.right>=s.left&&i.bottom>=s.top&&i.top<=s.bottom}static get YIBAIBADIVPI(){return h}static get PIDIV180(){return l}static get PI2(){return r}static get EPSILON(){return s}static equals(t,e){return Math.abs(t-e)<=s}static clamp(t,e,i){return t>i?i:t<e?e:t}static loadResource(t,e){e=e||{},t=t.replace(/\\/g,"/");let i="",s=t.lastIndexOf("/");if(-1!=s&&(i=t.slice(0,s),i+="/"),"undefined"!=typeof wx)wx.getFileSystemManager().readFile({filePath:t,encoding:"utf8",success:function(t){e.success&&e.success(t.data,i)},fail:function(t){e.fail&&e.fail(t.errMsg)},complete:function(){e.complete&&e.complete()}});else{let s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="text",s.onload=function(t){if(200==s.status){let t=s.responseText;e.success&&e.success(t,i)}else e.fail&&e.fail(s.statusText)},s.send(null),e.complete&&e.complete()}}}let a=Symbol("float32数组，3位");class o{constructor(t,e,i){this[a]=new Float32Array(3),null!=t&&(this[a][0]=t),null!=e&&(this[a][1]=e),null!=i&&(this[a][2]=i)}get x(){return this[a][0]}set x(t){this[a][0]=t}get y(){return this[a][1]}set y(t){this[a][1]=t}get z(){return this[a][2]}set z(t){this[a][2]=t}}let u=Symbol("List中的数据数组");class c{constructor(){this[u]=[]}get length(){return this[u].length}get size(){return this[u].length}get array(){return this[u]}exchangePosition(t,e){if(t==e)return;let i=this[u][t];this[u][t]=this[u][e],this[u][e]=i}set(t,e){t>=this.size||(this[u][t]=e)}isEmpty(){return 0==this.size}get(t){return this[u][t]}addAll(t){for(let e=0;e<t.length;e++){let i=null;null!=(i=t instanceof Array?t[e]:t.get(e))&&this.add(i)}}indexOf(t){for(var e=0;e<this.length;e++)if(this.get(e)==t)return e;return-1}add(t){this[u].push(t)}push(t){this[u].push(t)}pop(){this[u].pop()}insert(t,e){this[u].splice(e,0,t)}delete(t){t>=0&&t<this[u].length&&this[u].splice(t,1)}remove(t){for(var e=0;e<this.length;e++)if(this.get(e)==t){this[u].splice(e,1);break}}sort(t){function e(t,e,i){let s=t[e];t[e]=t[i],t[i]=s}for(let i=0;i<this[u].length;i++)for(let s=0;s<this[u].length-1-i;s++)t?t(this[u][s],this[u][s+1])&&e(this[u],s,s+1):this[u][s]>this[u][s+1]&&e(this[u],s,s+1)}contains(t){for(let e=0;e<this.length;e++){if(this.get(e)==t)return!0}return!1}clean(){this[u].length=0}}let d=Symbol("figure对象的唯一标示"),g=Symbol("figure左上角坐标点以及大小的一个数组,0位是x,1位是y,2位是z,3位是width,4位是height"),p=Symbol("figure旋转拉伸所在锚点的计算方法"),f=Symbol("子figure列表"),m=Symbol("父figure"),y=Symbol("缩放数组,0位是x缩放，1位是y缩放，2位是z缩放"),x=Symbol("旋转角度数组,0位是x轴角度，1位是y轴角度，2位是z轴角度"),v=Symbol("figure的透明度,0 - 1"),w=Symbol("figure是否显示 , boolean值"),M=Symbol("figure事件map"),V=Symbol("默认转换锚点"),_=Symbol("Figure所在的区域"),I=Symbol("figure相对于自身的bounds"),b=Symbol("Figure内部绘制是否发生了改变"),T=Symbol("Figure坐标、旋转、伸缩是否发生了改变"),A=Symbol("figure自身的变换4x4矩阵"),S=Symbol("figure的中心位置"),E=0;const C="add_child",P="remove_child",R="before_draw_self",F="parent_change",O="after_draw_self",D="transform_changed",L={name:null,figure:null,property:null};class q{constructor(t){t=t||{},this[d]=E++,this.autoIgnoreOutsizeChild=t.autoIgnore||!1,this[V]=new o,this[g]=new Float32Array(5),this[g][0]=t.x||0,this[g][1]=t.y||0,this[g][2]=t.z||0,this[g][3]=t.width||0,this[g][4]=t.height||0,this[y]=new o,this[y].x=t.scaleX||1,this[y].y=t.scaleY||1,this[y].z=t.scaleZ||1,this[x]=new o,this[x].x=t.rotateX||0,this[x].y=t.rotateY||0,this[x].z=t.rotate||0,this[v]=t.opacity||1,this[m]=null,this[M]=[],null!=this[w]?this[w]=t.visible:this[w]=!0,this[p]=null,this[f]=new c,this[_]=[],this[I]={left:0,top:0,right:this.width,bottom:this.height},this.relativeBounds={left:0,top:0,right:this.width,bottom:this.height,width:0,height:0},this[A]=tielifa.Mat4.identity(),this.relativeMatrix=tielifa.Mat4.identity(),this[T]=!0,this[b]=!0,this[S]=new o,this._tempP1=new Float32Array(4),this._tempP2=new Float32Array(4),this._tempP3=new Float32Array(4),this._tempP4=new Float32Array(4)}get id(){return this.Id}static get EVENT_TRANSFORM_CHANGED(){return D}static get EVENT_PARENT_CHANGE(){return F}static get EVENT_ADD_CHILD(){return C}static get EVENT_REMOVE_CHILD(){return P}static get EVENT_AFTER_DRAW_SELF(){return O}static get EVENT_BEFORE_DRAW_SELF(){return R}get center(){return this[S].x=this.width/2,this[S].y=this.height/2,this[S].z=this.depth/2,this[S]}get childrenSize(){return this[f].length}get parent(){return this[m]}set parent(t){this[m]!=t&&(L.name=F,L.figure=this,L.property={oldparent:this[m],currentparent:t},this[m]=t,this.fireEvent(F,L))}get relatedRegions(){return this[_]}set relatedRegions(t){this[_]=t}get isContentChanged(){return this[b]}fireContentChange(t){this[b]=t}get isTransformChanged(){return this[T]}fireTransformChange(t){t&&(this[T]||(L.figure=this,L.name=D,L.property=null,this.fireEvent(D,L))),this[T]=t}get transformAnchorCalculator(){return this[p]}set transformAnchorCalculator(t){this[p]=t}get opacity(){return this[v]}set opacity(t){n.equals(t,this[v])||(this[v]=t,this.fireContentChange(!0))}update(t){0!=this.width&&0!=this.height&&(t.save(),this.beforeDraw(t),this.applyTransform(t),this.applyDrawingStyle(t),this.drawSelf(t),this.afterDraw(t),this.updateChildren(t),t.restore())}beforeDraw(t){L.name=R,L.figure=this,L.property=null,this.fireEvent(R,L)}afterDraw(t){L.name=O,L.figure=this,L.property=null,this.fireEvent(O,L)}get Id(){return this[d]}get right(){return this.left+this.width}get bottom(){return this.top+this.height}get x(){return this.left}set x(t){this.left=t}get y(){return this.top}set y(t){this.top=t}get z(){return this.depth}set z(t){this.depth=t}get left(){return this[g][0]}set left(t){n.equals(t,this[g][0])||(this[g][0]=t,this.fireTransformChange(!0))}get top(){return this[g][1]}set top(t){n.equals(t,this[g][1])||(this[g][1]=t,this.fireTransformChange(!0))}get depth(){return this[g][2]}set depth(t){n.equals(t,this[g][2])||(this[g][2]=t,this.fireTransformChange(!0))}get width(){return this[g][3]}set width(t){n.equals(t,this[g][3])||(this[g][3]=t,this.fireContentChange(!0))}get height(){return this[g][4]}set height(t){n.equals(t,this[g][4])||(this[g][4]=t,this.fireContentChange(!0))}get rotate(){return this[x].z}set rotateX(t){t%=360,n.equals(t,this[x].x)||(this[x].x=t,this.fireTransformChange(!0))}get rotateX(){return this[x].x}set rotateY(t){t%=360,n.equals(t,this[x].y)||(this[x].y=t,this.fireTransformChange(!0))}get rotateY(){return this[x].y}set rotate(t){t%=360,n.equals(t,this[x].z)||(this[x].z=t,this.fireTransformChange(!0))}get scaleX(){return this[y].x}get scaleY(){return this[y].y}get scaleZ(){return this[y].z}set scaleX(t){n.equals(t,this[y].x)||(this[y].x=t,this.fireTransformChange(!0))}set scaleY(t){n.equals(t,this[y].y)||(this[y].y=t,this.fireTransformChange(!0))}set scaleZ(t){n.equals(t,this[y].z)||(this[y].z=t,this.fireTransformChange(!0))}get children(){return this[f]}get visible(){return this[w]}set visible(t){this[w]=t}drawSelf(t){}applyTransform(t){let e=this.getTransformMatrix();t.applyTransformMatrix(e)}applyDrawingStyle(t){t.globalAlpha=this.opacity}updateChildren(t){for(let e=0;e<this.children.length;e++){let i=this.children.get(e);i.visible&&(this.autoIgnoreOutsizeChild&&this.isOutside(i)||i.update(t))}}getTransformAnchor(){return this.transformAnchorCalculator?this.transformAnchorCalculator(this):this.getDefaultTransformAnchor()}getDefaultTransformAnchor(){return this[V].x=this.width/2,this[V].y=this.height/2,this[V].z=this.depth/2,this[V]}addEventListener(t,e){null!=this[M][t]&&null!=this[M][t]||(this[M][t]=[]),this[M][t].push(e)}removeEventListener(t,e){null!=this[M][t]&&this[M][t].pop(e)}cleanEventListener(t){null!=this[M][t]&&null!=this[M][t]&&(this[M][t].length=0)}fireEvent(t,e){if(null!=this[M][t])for(let i=0;i<this[M][t].length;i++){let s=this[M][t][i];s&&s(e)}}indexOf(t){return this[f].indexOf(t)}getGraph(){let t=this.parent;return t?t.getGraph():this}getChild(t){return this[f].get(t)}containsChild(t){return this[f].contains(t)}insertChild(t,e){if(null==t)return;if(this.containsChild(t))return;let i=t.parent;return i&&i.removeChild(t),this[f].insert(t,e),t.parent=this,L.name=C,L.figure=this,L.property={oldparent:i,currentparent:this,child:t},this.fireEvent(C,L),t}addChild(t){if(null==t)return;if(this.containsChild(t))return;let e=t.parent;return e&&e.removeChild(t),this[f].add(t),t.parent=this,L.name=C,L.figure=this,L.property={oldparent:e,currentparent:this,child:t},this.fireEvent(C,L),t}getRelativeTransformMatrix(t){let e=this.getTransformMatrix();if(t==this.parent)return e;let i=this.relativeMatrix;return tielifa.Mat4.identityMatrix(i),null!=this.parent&&null!=this.parent&&tielifa.Mat4.copy(this.parent.getRelativeTransformMatrix(t),i),tielifa.Mat4.multiply(i,i,e),i}getTransformMatrix(){if(this.isTransformChanged){tielifa.Mat4.identityMatrix(this[A]);let t=this[A],e=tielifa.Mat4.TEMP_MAT4[0];tielifa.Mat4.identityMatrix(e);let i=this.left,s=this.top,r=this.depth,l=this.scaleX,h=this.scaleY,a=this.scaleZ,o=this.rotate,u=this.rotateX,c=this.rotateY;n.equals(i,0)&&n.equals(s,0)&&n.equals(r,0)||(tielifa.Mat4.translationMatrix(e,i,s,r),tielifa.Mat4.multiply(t,t,e));let d=this.getTransformAnchor(),g=d.x,p=d.y,f=d.z,m=!1;n.equals(g,0)&&n.equals(p,0)&&n.equals(f,0)||(m=!0),m&&(tielifa.Mat4.translationMatrix(e,g,p,f),tielifa.Mat4.multiply(t,t,e)),n.equals(o,0)||(tielifa.Mat4.rotationZMatrix(e,o*n.PIDIV180),tielifa.Mat4.multiply(t,t,e)),n.equals(u,0)||(tielifa.Mat4.rotationXMatrix(e,u*n.PIDIV180),tielifa.Mat4.multiply(t,t,e)),n.equals(c,0)||(tielifa.Mat4.rotationYMatrix(e,c*n.PIDIV180),tielifa.Mat4.multiply(t,t,e)),m&&(tielifa.Mat4.translationMatrix(e,-g,-p,-f),tielifa.Mat4.multiply(t,t,e)),n.equals(l,1)&&n.equals(h,1)&&n.equals(a,1)||(tielifa.Mat4.scalingMatrix(e,l,h,a),tielifa.Mat4.multiply(t,t,e));let y=g/l-g,x=p/h-p,v=f/a-f;n.equals(y,0)&&n.equals(x,0)&&n.equals(v,0)||(tielifa.Mat4.translationMatrix(e,y,x,v),tielifa.Mat4.multiply(t,t,e)),this.fireTransformChange(!1)}return this[A]}getRelativeBounds(t){let e=this.getRelativeTransformMatrix(t),i=this.width,s=this.height;this._tempP1[0]=0,this._tempP1[1]=0,this._tempP1[2]=this.depth,this._tempP1[3]=1,this._tempP2[0]=i,this._tempP2[1]=0,this._tempP2[2]=this.depth,this._tempP2[3]=1,this._tempP3[0]=0,this._tempP3[1]=s,this._tempP3[2]=this.depth,this._tempP3[3]=1,this._tempP4[0]=i,this._tempP4[1]=s,this._tempP4[2]=this.depth,this._tempP4[3]=1;let r=tielifa.Mat4.multiplyWithVertex(e,this._tempP1,this._tempP1),l=tielifa.Mat4.multiplyWithVertex(e,this._tempP2,this._tempP2),h=tielifa.Mat4.multiplyWithVertex(e,this._tempP3,this._tempP3),n=tielifa.Mat4.multiplyWithVertex(e,this._tempP4,this._tempP4),a=r;l[0]<a[0]&&(a=l),h[0]<a[0]&&(a=h),n[0]<a[0]&&(a=n);let o=r;l[1]<o[1]&&(o=l),h[1]<o[1]&&(o=h),n[1]<o[1]&&(o=n);let u=r;l[0]>u[0]&&(u=l),h[0]>u[0]&&(u=h),n[0]>u[0]&&(u=n);let c=r;return l[1]>c[1]&&(c=l),h[1]>c[1]&&(c=h),n[1]>c[1]&&(c=n),this.relativeBounds.left=a[0],this.relativeBounds.top=o[1],this.relativeBounds.right=u[0],this.relativeBounds.bottom=c[1],this.relativeBounds.width=u[0]-a[0],this.relativeBounds.height=c[1]-o[1],this.relativeBounds}get absoluteRotate(){let t=this.rotate,e=this.parent;for(;null!=e;)t+=e.rotate,e=e.parent;return t}getSelectBounds(){return this.getRelativeBounds(this.getGraph())}isOutside(t){this[I].right=this.width,this[I].bottom=this.height;let e=t.getRelativeBounds(this);return!n.overlaps(this[I],e)}moveFigureToTop(t){if(this.containsChild(t)){let e=this.indexOf(t),i=this.childrenSize-1;this[f].exchangePosition(e,i)}}removeChild(t){if(null!=t)return this[f].remove(t),t.parent=null,L.name=P,L.figure=this,L.property={oldparent:this,currentparent:null,child:t},this.fireEvent(P,L),t}}class z{get isRunning(){return this._isRunning}constructor(t,e){this.debug=!1,this.repeat=t,this.stopcallback=e,this.threadId=null,this.stopped=!0,this.refreshCount=0,this._isRunning=!1}loop(t){this.stopped||(this.debug&&console.log(this.threadId+" 正在运行"),null!=this.repeat&&null!=this.repeat&&this.repeat(t),this.threadId=null,this.stopped||this.start())}setRepeatFunction(t){this.repeat=t}pause(){let t=this.refreshCount;this.stop(),this.refreshCount=t}start(){if(null==this.threadId){let t=this;this._isRunning=!0,this.stopped=!1,this.threadId=requestAnimationFrame(function(){t.refreshCount++,t.loop(t.refreshCount)}),this.debug&&console.log(this.threadId+" 就绪")}}stop(){this.debug&&console.log(this.threadId+" 停止"),this.stopped=!0,cancelAnimationFrame(this.threadId),this.threadId=null,this._isRunning=!1,this.stopcallback&&this.stopcallback(this.refreshCount),this.refreshCount=0}}let N=Symbol("暂停循环刷新是否已暂停");class B extends q{constructor(t,e){super(e),this.x=0,this.y=0,this.z=0,this.width=t.width,this.height=t.height,this.ctx=new tielifa.WebGL2D(t,e),this.canvas=t,this.loopInterface=null,this._loop=new z;let i=this;this._loop.repeat=function(t){i.loopRefresh(t)},this[N]=!1}loadImage(t,e,i,s){this.ctx.loadImage(t,e,i,s)}getTexture(t,e){return this.ctx.getTexture(t,e)}get paused(){return this[N]}update(){this.clean(),super.update(this.ctx),this.ctx.draw()}get parent(){return null}set parent(t){}clean(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}drawSelf(t){}loopRefresh(){this.loopInterface&&this.loopInterface.loopStart&&this.loopInterface.loopStart(),this.paused||(this.update(),this.loopInterface&&this.loopInterface.loopEnd&&this.loopInterface.loopEnd())}pause(){this[N]=!0}startLoopRefresh(t){this.paused?this[N]=!1:(this.loopInterface=t,this._loop.start())}stopLoopRefresh(){this._loop.stop()}}let W=Symbol("坐标值");class X{get x(){return this[W][0]}set x(t){this[W][0]=t}get y(){return this[W][1]}set y(t){this[W][1]=t}constructor(t,e){this[W]=new Float32Array(2),this.x=t,this.y=e}clone(){return new X(this.x,this.y)}}let Y=Symbol("figure的物理模型"),k=Symbol("质量"),j=Symbol("转动惯量"),G=Symbol("是否可碰撞，true则会进行碰撞测试，反之不会");class H extends q{constructor(t){super(t=t||{}),null!=t.contactable?this[G]=t.contactable:this[G]=!0,this.physicsModel=t.physicsModel||t,this[j]=void 0,this[k]=t.mass||1}get contactable(){return this[G]}set contactable(t){this[G]=t}set physicsModel(t){this[Y]=t}get physicsModel(){return this[Y]}get mass(){return this[k]}set mass(t){this[k]=t}get momentInertia(){return this.mass==1/0?1/0:null==this.physicsModel?(null==this[j]&&(this[j]=this.mass*(this.width*this.width+this.height*this.height)/12),this[j]):this.physicsModel.momentInertia}get inverseInertia(){return this.mass==1/0?0:1/this.momentInertia}get inverseMass(){return this.mass==1/0?0:1/this.mass}}let U=Symbol("速度"),Z=Symbol("角速度"),J=Symbol("受力"),K=Symbol("受力位置"),Q=Symbol("加速度"),$=Symbol("x轴休眠"),tt=Symbol("y轴休眠"),et=Symbol("旋转休眠"),it=Symbol("质心"),st=Symbol("前一时刻的速度"),rt=Symbol("前一时刻的角速度"),lt=Symbol("前一时间的位置"),ht=Symbol("前一时刻的旋转度数"),nt=Symbol("是否运动，如果为false则不会根据其速度重新计算位置"),at=Symbol("暂停运动");const ot=1,ut="beforeCalculatePose",ct="afterCalculatePose",dt={name:null,figure:null};class gt extends H{constructor(t){super(t=t||{}),this[st]=new tielifa.Vector2(0,0),this[lt]=new X(0,0),this[rt]=0,this[U]=t.velocity||new tielifa.Vector2(0,0),this[J]=t.force||new tielifa.Vector2(0,0),this[Z]=t.angularVelocity||0,this[Q]=new tielifa.Vector2(0,0),this[$]=!1,this[tt]=!1,this.filter=t.filter||tielifa.WebGL2D.Normal_Filter,this[nt]=!1,this[it]=t.massCenter,this[at]=!1}static get EVENT_BEFORE_CALCULATE_POSE(){return ut}static get AFTER_BEFORE_CALCULATE_POSE(){return ct}static get DELTA_TIME(){return ot}get forcePosition(){return null==this[K]&&(this[K]=new X(this.width/2,this.height/2)),this[K]}set forcePosition(t){this.forcePosition.x=t.x,this.forcePosition.y=t.y}overlap(t){let e=this.getSelectBounds(),i=t.getSelectBounds();return n.overlaps(e,i)}get isStaticFigure(){return this.mass==1/0}get isSleeping(){return 0==this.velocity.x&&0==this.velocity.y&&0==this.angularVelocity}get sleepX(){return this[$]}get sleepY(){return this[tt]}get massCenter(){return null==this[it]&&(this[it]=new X(this.center.x,this.center.y)),this[it]}set massCenter(t){this[it].x=t.x,this[it].y=t.y}get angularVelocity(){return this[Z]}set angularVelocity(t){this[Z]=t}get speed(){return this.velocity.magnitude}get velocity(){return this[U]}set velocity(t){this[U].x=t.x,this[U].y=t.y}get force(){return this[J]}set force(t){this[J].x=t.x,this[J].y=t.y}get acceleration(){return this[Q].x=this.force.x*this.inverseMass,this[Q].y=this.force.y*this.inverseMass,this[Q]}get angularAcceleration(){return this.torque*this.inverseInertia}get nextFrameVelocity(){}get preRotate(){return this[ht]}get preVelocity(){return this[st]}get prePosition(){return this[lt]}get preAngularVelocity(){return this[rt]}get torque(){return(this.forcePosition.x-this.massCenter.x)*this.force.x-(this.forcePosition.y-this.massCenter.y)*this.force.y}applyDrawingStyle(t){super.applyDrawingStyle(t),t.filterType=this.filter}backToPre(){this.left=this.prePosition.x,this.top=this.prePosition.y,this.rotate=this.preRotate,this.velocity.x=this.preVelocity.x,this.velocity.y=this.preVelocity.y,this.angularVelocity=this.preAngularVelocity}beforeDraw(t){this[nt]&&!this.paused&&this.calculateCurrentPose(),super.beforeDraw(t)}calculateCurrentPose(){dt.figure=this,dt.name=ut,this.fireEvent(ut,dt);let t=this.acceleration,e=this.angularAcceleration;this[st].x=this.velocity.x,this[st].x=this.velocity.y;let i=this.velocity.x+t.x*ot,s=this.velocity.y+t.y*ot,r=!1,l=!1;(i*this.velocity.x<0||Math.abs(i+this.velocity.x)<=n.EPSILON)&&(r=!0),(s*this.velocity.y<0||Math.abs(s+this.velocity.y)<=n.EPSILON)&&(l=!0),this.velocity.x=i,this.velocity.y=s,this[lt].x=this.left,this[lt].y=this.top,this.left+=this.velocity.x*ot,this.top+=this.velocity.y*ot,this[rt]=this.angularVelocity;let h=e*ot+this.angularVelocity,a=!1;(h*this.angularVelocity<0||Math.abs(h+this.angularVelocity)<=n.EPSILON/1e3)&&(a=!0),this.angularVelocity=h,this[ht]=this.rotate,this.rotate+=this.angularVelocity*ot*n.YIBAIBADIVPI,a&&!this[et]&&(this.fireEvent("sleepRotate",{source:this}),this[et]=!0),r&&!this[$]&&(this.fireEvent("sleepX",{source:this}),this[$]=!0),l&&!this[tt]&&(this.fireEvent("sleepY",{source:this}),this[tt]=!0),dt.name=ct,this.fireEvent(ct,dt)}startMove(){this.paused?this[at]=!1:(this[$]=!1,this[tt]=!1,this[et]=!1,this[nt]=!0,this[at]=!1)}get paused(){return this[at]}pauseMove(){this[at]=!0}stopMove(){this[$]=!0,this[tt]=!0,this[et]=!0,this[nt]=!1,this[U].x=this[U].y=0,this[Z]=0,this[J].x=this[J].y=0,this[at]=!1}}class pt{constructor(t,e,i,s){this.left=t,this.top=e,this.right=i,this.bottom=s,this.relatedFigures=new c,this.id=-1}addFigure(t){this.relatedFigures.add(t)}removeFigure(t){this.relatedFigures.remove(t)}}class ft{constructor(t,e,i,s){let r=Math.floor(i/e);i%e!=0&&e++;let l=Math.floor(s/t);s%t!=0&&t++,this.row=t,this.column=e,this.regions=new Array(t);for(let i=0;i<t;i++)this.regions[i]=new Array(e);let h=0;for(let i=0;i<t;i++){let t=i*l,s=t+l;for(let l=0;l<e;l++){let e=l*r,n=new pt(e,t,e+r,s);n.id=h,this.regions[i][l]=n,h++}}this.regionWidth=r,this.regionHeight=l}calculateRegionIndex(t,e){let i=Math.floor(t/this.regionWidth);return{row:Math.floor(e/this.regionHeight),column:i}}calculateRegionId(t){return t.row*this.column+t.column}findRegionId(t,e){let i=this.calculateRegionIndex(t,e);return this.getRegionId(i)}getRegion(t){let e=Math.floor(t/this.column);if(null!=this.regions[e]){let i=t-e*this.column;return this.regions[e][i]}}getRegionId(t){if(t.row>=0&&t.row<this.row&&t.column>=0&&t.column<this.column){return this.regions[t.row][t.column].id}}getRegions(t,e,i,s){let r=i;null==r?r=[]:r.length=0;let l=t.row,h=t.column,n=e.row-l+1,a=e.column-h+1;for(let t=0;t<n;t++)for(let e=0;e<a;e++){let i=this.getRegionId({row:t+l,column:e+h});if(null!=i){let t=this.getRegion(i);null!=s&&t.addFigure(s),r.push(i)}}return r}updateRegionsOfFigure(t){let e=t.getSelectBounds(),i=this.calculateRegionIndex(e.left,e.top),s=this.calculateRegionId(i),r=this.calculateRegionIndex(e.right,e.bottom),l=this.calculateRegionId(r),h=t.relatedRegions;if(0!=h.length){let t=h[0],e=h[h.length-1];if(t==s&&e==l)return}for(let e=0;e<t.relatedRegions.length;e++){let i=t.relatedRegions[e];this.getRegion(i).removeFigure(t)}t.relatedRegions.length=0,this.getRegions(i,r,t.relatedRegions,t)}test(){console.log(this.regions)}}const mt=.001;class yt{constructor(){}static collisionTest(t,e){let i={collision:!1,minOverlapFigure:void 0,minOverlapAxisIndex:-1,MTV:{minOverlap:void 0,direction:void 0}},s=t.vertices,r=e.vertices;i.centerA=t.center,i.centerB=e.center,i.verticesA=t.vertices,i.verticesB=e.vertices;let l=t.axis,h={figure:void 0,min:0,max:0,minVertex:void 0,maxVertex:void 0},a={figure:void 0,min:0,max:0,minVertex:void 0,maxVertex:void 0};h.figure=t,a.figure=e;let o=void 0,u=void 0,c=-1;for(let e=0;e<l.length;e++){let n=l[e];this.projectionToAxis(h,s,n),this.projectionToAxis(a,r,n);let d=this.getMinOverlap(void 0,h,a);if(null==o?(o=d,u=t,c=e):d.value<o.value&&(o=d,u=t,c=e),o.value<=0)return i.collision=!1,i}let d,g=e.axis;for(let t=0;t<g.length;t++){let l=g[t];this.projectionToAxis(h,s,l),this.projectionToAxis(a,r,l);let n=this.getMinOverlap(void 0,h,a);if(n.value<o.value&&(o=n,u=e,c=t),o.value<=0)return i.collision=!1,i}o.value=Math.ceil(1e3*o.value)/1e3,i.collision=!0,i.MTV.minOverlap=o;let p,f,m={p1:void 0,p2:void 0,p3:void 0,p4:void 0};d=u==t?l[c]:g[c],p=o.max.figure==t?M(o.max.vertex,s,d):M(o.max.vertex,r,d),f=o.min.figure==t?M(o.min.vertex,s,d):M(o.min.vertex,r,d),p.p3=f.p1,p.p4=f.p2,null==p.p2?(m.p1=p.p3,m.p2=p.p4):(m.p1=p.p1,m.p2=p.p2),null!=f.p4&&(m.p3=p.p3,m.p4=p.p4);for(let i in m){let r=m[i];null!=r&&(r.vertices==s?r.figure=t:r.figure=e)}let y=[],x=p.p1,v=p.p1,w={x:-d.y,y:d.x};for(let t in p){let e=p[t],i=x.vertices[x.index],s=v.vertices[v.index];if(e){let t=e.vertices[e.index],r=tielifa.Vector2.dot(i,w),l=tielifa.Vector2.dot(s,w),h=tielifa.Vector2.dot(t,w);h>r&&(x=e),h<l&&(v=e)}}for(let t in p){let e=p[t];e!=x&&e!=v&&(null!=e&&y.push(e))}function M(t,e,i){let s=e[t],r=(t-1+e.length)%e.length,l=(t+1+e.length)%e.length,h=e[r],a=e[l],o=new tielifa.Vector2(a.x-s.x,a.y-s.y);tielifa.Vector2.normalize(o,o);let u=new tielifa.Vector2(s.x-h.x,s.y-h.y);tielifa.Vector2.normalize(u,u);let c=Math.abs(tielifa.Vector2.dot(o,i)),d=Math.abs(tielifa.Vector2.dot(u,i));return c>=d?n.equals(d,0)||Math.abs(d)<=mt?{p1:{index:r,vertices:e},p2:{index:t,vertices:e}}:{p1:{index:t,vertices:e},p2:null}:d>=c?n.equals(c,0)||Math.abs(d)<=mt?{p1:{index:t,vertices:e},p2:{index:l,vertices:e}}:{p1:{index:t,vertices:e},p2:null}:void 0}return i.p1=y[0].vertices[y[0].index],y[0].vertices==s?y[0].figure=t:y[0].figure=e,2==y.length&&(i.p2=y[1].vertices[y[1].index],y[1].vertices==s?y[1].figure=t:y[1].figure=e),i.contactPoints=y,i.MTV.direction=d,i.minOverlapAxisIndex=c,i.contactPlane=m,i}static getMinOverlap(t,e,i){null==t&&(t={max:{},min:{}});let s=e.max-i.min,r=i.max-e.min,l=t;return s<r?(l.value=s,l.max.figure=e.figure,l.max.vertex=e.maxVertex,l.min.figure=i.figure,l.min.vertex=i.minVertex):(l.value=r,l.max.figure=i.figure,l.max.vertex=i.maxVertex,l.min.figure=e.figure,l.min.vertex=e.minVertex),t}static projectionToAxis(t,e,i){let s=tielifa.Vector2.dot(e[0],i),r=0,l=s,h=r;for(let t=1;t<e.length;t++){let n=tielifa.Vector2.dot(e[t],i);n>l&&(l=n,h=t),n<s&&(s=n,r=t)}t.min=s,t.minVertex=r,t.max=l,t.maxVertex=h}}const xt=1e-5,vt=10,wt={v1:{x:0,y:0},v2:{x:0,y:0},w1:0,w2:0,warmTangentImpulse:0,warmNormalImpulse:0},Mt={x:0,y:0};new tielifa.Vector2(0,0),new tielifa.Vector2(0,0);class Vt{constructor(){}static solve(t,e,i,s,r,l,h,a,o,u,c,d,g,p,f,m){null==f&&(f=0),null==m&&(m=0);let y=o,x={x:s.x-i.x,y:s.y-i.y};tielifa.Vector2.dot(x,y)>0&&(y.x*=-1,y.y*=-1),null==g&&(g=1),null==p&&(p=.2);let v=Math.max(d-g,0);v*=p;let w=wt,M={x:0,y:0,normalImpulseSum:0,tangentImpulseSum:0,affectTangentMass:void 0,t:void 0};for(let t=0;t<h.length;t++){let e=h[t].vertices[h[t].index];M.x+=e.x,M.y+=e.y}M.x=M.x/h.length,M.y=M.y/h.length,M.r1={x:M.x-i.x,y:M.y-i.y},M.r2={x:M.x-s.x,y:M.y-s.y};let V=t.inverseMass+e.inverseMass,_=tielifa.Vector2.cross(M.r1,o);_=_*_*t.inverseInertia;let I=tielifa.Vector2.cross(M.r2,o);I=I*I*e.inverseInertia,M.affectNormalMass=_+I+V;let b={x:-o.y,y:o.x},T=M.r1,A=M.r2,S=Mt;S.x=S.y=0,S.x=-t.angularVelocity*T.y,S.y=t.angularVelocity*T.x;let E=S.x+t.velocity.x,C=S.y+t.velocity.y;S.x=-e.angularVelocity*A.y,S.y=e.angularVelocity*A.x,S.x=S.x+e.velocity.x,S.y=S.y+e.velocity.y,S.x=E-S.x,S.y=C-S.y,tielifa.Vector2.dot(b,S)<0&&(b.x*=-1,b.y*=-1),tielifa.Vector2.multiplyValue(S,o,f*t.inverseMass),t.velocity.x+=S.x,t.velocity.y+=S.y,tielifa.Vector2.multiplyValue(S,b,m*t.inverseMass),t.velocity.x+=S.x,t.velocity.y+=S.y,tielifa.Vector2.multiplyValue(S,o,f*e.inverseMass),e.velocity.x-=S.x,e.velocity.y-=S.y,tielifa.Vector2.multiplyValue(S,b,m*e.inverseMass),e.velocity.x-=S.x,e.velocity.y-=S.y,t.angularVelocity+=tielifa.Vector2.cross(M.r1,o)*(t.inverseInertia*f),t.angularVelocity+=tielifa.Vector2.cross(M.r1,b)*(t.inverseInertia*m),e.angularVelocity-=tielifa.Vector2.cross(M.r2,o)*(e.inverseInertia*f),e.angularVelocity-=tielifa.Vector2.cross(M.r2,b)*(e.inverseInertia*m),w.v1.x=t.velocity.x,w.v1.y=t.velocity.y,w.v2.x=e.velocity.x,w.v2.y=e.velocity.y,w.w1=t.angularVelocity,w.w2=e.angularVelocity;let P=0,R=0;for(let i=0;i<vt;i++){let i=M.r1,s=M.r2,r=this.computeImpulse2(w.v1,w.v2,w.w1,w.w2,M,t.inverseMass,e.inverseMass,t.inverseInertia,e.inverseInertia,o,u,c,v,1);P=r.jn,R=r.jt;let l=M.normalImpulseSum;if(M.normalImpulseSum=Math.max(M.normalImpulseSum+P,0),(P=M.normalImpulseSum-l)<0)break;if(l=M.tangentImpulseSum,M.tangentImpulseSum=n.clamp(M.tangentImpulseSum+R,-1*M.normalImpulseSum,M.normalImpulseSum),R=M.tangentImpulseSum-l,Math.abs(P)<xt||0===P)break;let h=r.t,a=Mt;a.x=a.y=0,tielifa.Vector2.multiplyValue(a,o,P*t.inverseMass),w.v1.x+=a.x,w.v1.y+=a.y,tielifa.Vector2.multiplyValue(a,h,R*t.inverseMass),w.v1.x+=a.x,w.v1.y+=a.y,tielifa.Vector2.multiplyValue(a,o,P*e.inverseMass),w.v2.x-=a.x,w.v2.y-=a.y,tielifa.Vector2.multiplyValue(a,h,R*e.inverseMass),w.v2.x-=a.x,w.v2.y-=a.y,w.w1+=tielifa.Vector2.cross(i,o)*(t.inverseInertia*P),w.w1+=tielifa.Vector2.cross(i,h)*(t.inverseInertia*R),w.w2-=tielifa.Vector2.cross(s,o)*(e.inverseInertia*P),w.w2-=tielifa.Vector2.cross(s,h)*(e.inverseInertia*R)}return w.warmTangentImpulse=M.tangentImpulseSum,w.warmNormalImpulse=M.normalImpulseSum,w}static computeImpulse2(t,e,i,s,r,l,h,a,o,u,c,d,g){let p=r.r1,f=r.r2,m={x:0,y:0};m.x=-i*p.y,m.y=i*p.x;let y=m.x+t.x,x=m.y+t.y;m.x=-s*f.y,m.y=s*f.x,m.x=m.x+e.x,m.y=m.y+e.y,m.x=y-m.x,m.y=x-m.y;let v=r.affectNormalMass,w=r.affectTangentMass,M=r.t;if(null==w){M={x:-u.y,y:u.x},tielifa.Vector2.dot(M,m)<0&&(M.x*=-1,M.y*=-1),r.t=M;let t=l+h,e=tielifa.Vector2.cross(r.r1,M);e=e*e*a;let i=tielifa.Vector2.cross(r.r2,M);i=i*i*o,r.affectNormalMass=e+i+t,w=r.affectNormalMass}let V=-1-c;m.x*=V,m.y*=V;let _=tielifa.Vector2.dot(m,u)/v,I=tielifa.Vector2.dot(m,M)/w,b=(_+=g)*d;return{jn:_,jt:I=n.clamp(I,-1*b,b),t:M}}static computeImpulse(t,e,i,s,r,l,h,a,o,u,c,d,g,p,f){f=f||1;let m={x:-c.y,y:c.x},y={x:0,y:0};y.x=-i*o.y,y.y=i*o.x;let x=y.x+t.x,v=y.y+t.y;y.x=-s*u.y,y.y=s*u.x,y.x=y.x+e.x,y.y=y.y+e.y,y.x=x-y.x,y.y=v-y.y,tielifa.Vector2.dot(m,y)<0&&(m.x*=-1,m.y*=-1);let w=tielifa.Vector2.dot(y,m);w*=-1;let M=-1-d;y.x*=M,y.y*=M;let V=tielifa.Vector2.dot(y,c),_=0,I=0;0!=h&&(_=(_=tielifa.Vector2.cross(o,c))*_*h,I=(I=tielifa.Vector2.cross(o,m))*I*h);let b=0,T=0;0!=a&&(b=(b=tielifa.Vector2.cross(u,c))*b*a,T=(T=tielifa.Vector2.cross(u,m))*T*a);let A=l+r,S=V/((_+b+A)*f),E=w/((I+T+A)*f),C=(S+=p)*g;return{jn:S,jt:E=n.clamp(E,-1*C,C),t:m}}}class _t{constructor(){}static getAxis(t,e,i){let s=[];null==i&&(i=!0),null==e&&(e=[]);for(let l=0;l<t.length;l++){let h=t[l],n=t[(l+1)%t.length],a=new tielifa.Vector2(n.y-h.y,h.x-n.x),o=Math.atan2(a.y,a.x);i&&r(s,o)||(s.push(o),tielifa.Vector2.normalize(a,a),e.push(a))}function r(t,e){for(let i=0;i<t.length;i++)if(n.equals(e,t[i]))return!0;return!1}return s=null,e}}const It=0,bt=1,Tt=[0,0,1];class At{constructor(t){t=t||{},this.type=t.type||It,this.axis=[],this.vertices=null,this.radiusX=null,this.radiusY=null,this.originalVertices=[],this.originalAxis=[],this.originalCenter=null,this.center=null,this._mass=1,this.inertia,null!=t.friction?this.friction=t.friction:this.friction=1,null!=t.elastic?this.elastic=t.elastic:this.elastic=1}get mass(){return this._mass}set mass(t){this._mass=t}get momentInertia(){if(this.mass==1/0)return 1/0;if(null==this.inertia){let t=0,e=0,i=this.vertices;for(let s=0;s<i.length;s++){let r=(s+1)%i.length,l=Math.abs(tielifa.Vector2.cross(i[r],i[s]));t+=l*(tielifa.Vector2.dot(i[r],i[r])+tielifa.Vector2.dot(i[r],i[s])+tielifa.Vector2.dot(i[s],i[s])),e+=l}if(0==e)return 1;this.inertia=this.mass/6*(t/e)}return this.inertia}static createDefaultModel(t,e){let i=new At(e),s=[];return s.push({x:0,y:0}),s.push({x:t.width,y:0}),s.push({x:t.width,y:t.height}),s.push({x:0,y:t.height}),i.generateModel(s,t.center,t.mass),i}static createRegularTriangleModel(t,e){let i=new At(e),s=[];return s.push({x:t.width/2,y:0}),s.push({x:0,y:t.height}),s.push({x:t.width,y:t.height}),i.generateModel(s,t.center,t.mass),i}static createRegularHexagonModel(t,e){let i=new At(e),s=[];return s.push({x:t.width/3,y:0}),s.push({x:t.width/3*2,y:0}),s.push({x:t.width,y:t.height/2}),s.push({x:t.width/3*2,y:t.height}),s.push({x:t.width/3,y:t.height}),s.push({x:0,y:t.height/2}),i.generateModel(s,t.center,t.mass),i}generateModel(t,e,i){if(t instanceof Array){this.type=It,this.vertices=t,_t.getAxis(this.vertices,this.axis);for(let t=0;t<this.vertices.length;t++){let e=this.vertices[t];this.originalVertices.push({x:e.x,y:e.y})}for(let t=0;t<this.axis.length;t++){let e=this.axis[t];this.originalAxis.push(new tielifa.Vector2(e.x,e.y))}this.center={x:e.x,y:e.y},this.originalCenter={x:e.x,y:e.y}}else this.type=bt,this.center={x:e.x,y:e.y},this.originalCenter={x:e.x,y:e.y},this.radiusX=t.radiusX,this.radiusY=t.radiusY;this.mass=i,this.momentInertia}applyCurrentTransform(t,e){let i=tielifa.Mat3.TEMP_MAT3[0];if(i[0]=e[0],i[1]=e[1],i[2]=0,i[3]=e[4],i[4]=e[5],i[5]=0,i[6]=e[12],i[7]=e[13],i[8]=1,!Math.abs(t)<1e-7)for(let e=0;e<this.axis.length;e++){let i=this.axis[e],s=this.originalAxis[e];tielifa.Vector2.rotate(i,s,t*n.PIDIV180)}let s=Tt;for(let t=0;t<this.originalVertices.length;t++){let e=this.originalVertices[t];tielifa.Mat3.multiplyWithVertex(s,i,[e.x,e.y,1]),this.vertices[t].x=s[0],this.vertices[t].y=s[1]}tielifa.Mat3.multiplyWithVertex(s,i,[this.originalCenter.x,this.originalCenter.y,1]),this.center.x=s[0],this.center.y=s[1]}}let St=Symbol("动画延迟开始的时间值"),Et=Symbol("动画循环次数"),Ct=Symbol("xunhuancishu temp"),Pt=Symbol("动画的总时长,单位毫秒");const Rt="complete",Ft="interrupt",Ot=.06;class Dt{get isRunning(){return this._startRun}get loop(){return this[Et]}set loop(t){this[Et]=t,this[Ct]=t}get delay(){return this[St]}set delay(t){this[St]=t}get totalTime(){return this[Pt]}set totalTime(t){this[Pt]=t}static get EASE(){return Nt}static get EASE_OUT(){return zt}static get EASE_IN_OUT(){return Lt}static get EASE_OUT_IN(){return qt}static get LINEAR(){return Bt}constructor(t,e,i,s){if(this.id=(new Date).getTime().toString()+Math.floor(100*Math.random()),!t)throw Error("动画主体figure不能为空");this.figure=t,this.type=i||Bt,this[Pt]=e||500,this.finalValues=[],this.originalValues=[],this.applyProperties=[],this._startRun=!1,this.preAnimation=void 0,this.nextAnimation=void 0;let r=this;this.loopFunction=function(t){r._startRun&&(r.repeat(),r.refreshCount++)},this._paused=!1,this[Et]=0,this[Ct]=void 0,this.callbacks=s,this.refreshCount=0}get paused(){let t=this;for(;t;){if(t._paused)return!0;t=t.preAnimation}let e=this;for(;e;){if(e._paused)return!0;e=e.nextAnimation}return!1}recordFigureValues(t,e,i){if(this.finalValues[i]=t,this.preAnimation){var s=this.preAnimation.finalValues[i];this.originalValues[i]=s||e}else this.originalValues[i]=e;this.applyProperties.push(i)}moveTo(t,e){return this.recordFigureValues(t,this.figure.left,"left"),this.recordFigureValues(e,this.figure.top,"top"),this}scaleTo(t,e){return this.recordFigureValues(t,this.figure.scaleX,"scaleX"),this.recordFigureValues(e,this.figure.scaleY,"scaleY"),this}propertyChangeTo(t,e){return this.recordFigureValues(t,this.figure[e],e),this}rotateTo(t){return this.recordFigureValues(t,this.figure.rotate,"rotate"),this}applyOriginalValue(){for(var t=0;t<this.applyProperties.length;t++){var e=this.applyProperties[t];this.figure[e]=this.originalValues[e]}}applyDeltaValue(t){for(var e=0;e<this.applyProperties.length;e++){var i=this.applyProperties[e];this.figure[i]+=t[i]}}applyFigureChange(t){for(var e=0;e<this.applyProperties.length;e++){var i=this.applyProperties[e],s=this.originalValues[i],r=this.calculateDeltaValue(t,i);this.figure[i]=s+r}}applyFinalValue(){for(var t=0;t<this.applyProperties.length;t++){var e=this.applyProperties[t];this.figure[e]=this.finalValues[e]}}then(t,e){return this.nextAnimation=new Dt(this.figure,t,e),this.nextAnimation.loop=this.loop,this.nextAnimation.preAnimation=this,this.nextAnimation}calculateDeltaValue(t,e){var i=this.originalValues[e],s=this.finalValues[e]-i;if(0==s)return 0;let r=Math.floor(this.totalTime*Ot);var l=this.type,h=!1;if(l==Lt||l==qt){s/=2,r/=2,(l=Nt)==qt&&(l=zt);var n=this.figure[e];Math.abs(n-i)>=Math.abs(s)&&((l=zt)==qt&&(l=Nt),h=!0,t-=r)}l==Bt&&(a=(o=s/r)*t);if(l==Nt)var a=s*t*t/(r*r);if(l==zt){var o;a=(o=2*s/(r*r))*r*t-o*t*t/2}return h&&(a+=s),a}reachFinalFrame(t){if(t>=Math.floor(this.totalTime*Ot))return!0;for(var e=!0,i=0;i<this.applyProperties.length;i++){var s=this.applyProperties[i],r=this.finalValues[s]-this.originalValues[s];r>0&&(this.figure[s]>=this.finalValues[s]||(e=!1)),r<0&&(this.figure[s]<=this.finalValues[s]||(e=!1))}return e}cleanAnimationData(){this.finalValues.length=0,this.originalValues.length=0,this.applyProperties.length=0,this[Et]=0}repeat(){this.applyFigureChange(this.refreshCount),this.reachFinalFrame(this.refreshCount)&&(this.applyFinalValue(),this.complete(),this.nextAnimation&&this.nextAnimation.launchImmediately())}complete(){this.stop(Rt)}interrupt(){this.stop(Ft)}stop(t){if((t=t||Ft)===Ft){let t=this;for(;t;)t.applyOriginalValue(),this.figure.removeEventListener(q.EVENT_BEFORE_DRAW_SELF,t.loopFunction),t=t.preAnimation;let e=this.nextAnimation;for(;e;)this.figure.removeEventListener(q.EVENT_BEFORE_DRAW_SELF,e.loopFunction),e=e.nextAnimation;return}this._startRun=!1,this.refreshCount=0,this.loop>0&&this.loop--;let e=this.preAnimation;if(e)for(;null!=e.preAnimation;)e=e.preAnimation;else e=this;if(0===this.loop)this.cleanAnimationData(),this.figure.removeEventListener(q.EVENT_BEFORE_DRAW_SELF,this.loopFunction),this.callbacks&&(t===Ft?this.callbacks.stop&&this.callbacks.stop():t===Rt&&this.callbacks.complete&&this.callbacks.complete());else{if(this.nextAnimation)return void this.nextAnimation.launchImmediately();if(this.preAnimation){let t=this;for(;t!==e;)t.applyOriginalValue(),t=t.preAnimation;return void e.launchImmediately()}this.launchImmediately()}}setRunningAnimationOnChainPause(t){if(t&&this.isRunning)return this._startRun=!t,void(this._paused=t);if(!t&&this._paused)return this._startRun=!t,void(this._paused=t);let e=this.preAnimation;for(;e;)t&&e.isRunning&&(e._startRun=!t,e._paused=t),!t&&e._paused&&(e._startRun=!t,e._paused=t),e=e.preAnimation;let i=this.nextAnimation;for(;i;)t&&i.isRunning&&(i._startRun=!t,i._paused=t),!t&&i._paused&&(i._startRun=!t,i._paused=t),i=i.nextAnimation}pause(){this.setRunningAnimationOnChainPause(!0)}start(t){this.paused?this.setRunningAnimationOnChainPause(!1):(this.figure.addEventListener(q.EVENT_BEFORE_DRAW_SELF,this.loopFunction),t&&(this.callbacks=t),this.preAnimation?this.preAnimation.start():(this.applyOriginalValue(),this.launchImmediately()))}launchImmediately(){let t=this;null!=this.delay?setTimeout(function(){t.refreshCount=0,this._startRun=!0},this.delay):(this.refreshCount=0,this._startRun=!0)}}const Lt="ease_in_out",qt="ease_out_in",zt="ease_out",Nt="ease",Bt="linear";class Wt extends q{constructor(t){super(t=t||{}),this.color=t.color||"black",this.borderColor=t.borderColor,this.borderWidth=t.borderWidth||0}applyDrawingStyle(t){super.applyDrawingStyle(t),t.fillStyle=this.color,this.borderColor&&(t.strokeStyle=this.borderColor),t.lineWidth=this.borderWidth}drawSelf(t){t.beginPath(),this.defineShapePath(t),t.closePath(),t.fill(),this.borderColor&&t.stroke()}defineShapePath(t){}}class Xt extends Wt{constructor(t){super(t=t||{}),this.radiusX=t.radiusX||0,this.radiusY=t.radiusY||0,this.centerX=t.centerX||0,this.centerY=t.centerY||0}get centerX(){return this.left+this.radiusX}set centerX(t){this.left=t-this.radiusX}get centerY(){return this.top+this.radiusY}set centerY(t){this.top=t-this.radiusY}get radiusX(){return this.width/2}set radiusX(t){this.width=2*t}get radiusY(){return this.height/2}set radiusY(t){this.height=2*t}get width(){return super.width}get height(){return super.height}set width(t){super.width=t}set height(t){super.height=t}defineShapePath(t){t.ellipse(this.radiusX,this.radiusY,this.radiusX,this.radiusY,0,0,2*Math.PI)}}let Yt=Symbol("地图数据");let kt={};!function t(e,i){for(let s in e){let r=e[s],l=r;"object"==typeof l&&t(r,l={}),Object.defineProperty(i,s,{get:function(){return l}})}}({version:"0.0.1",Graph:B,shape:{Ellipse:Xt,Circle:class extends Xt{constructor(t){super(t=t||{}),this.radius=t.radius||0}get radius(){return this.radiusX}set radius(t){this.radiusX=t}get width(){return super.width}get height(){return super.height}set width(t){super.width=t,super.height=t}set height(t){this.width=t}},Rectangle:class extends Wt{constructor(t){if(super(t=t||{}),this.radius=t.radius||0,this.radius<0)throw new Error("radius should bigger than zero")}defineShapePath(t){if(0==this.radius)t.rect(0,0,this.width,this.height);else{let e=Math.min(this.width,this.height);if(this.radius>e/2)throw new Error("radius should less than half of width or height");t.moveTo(this.radius,0),t.lineTo(this.width-this.radius,0),t.arc(this.width-this.radius,this.radius,this.radius,-Math.PI/2,0),t.lineTo(this.width,this.height-this.radius),t.arc(this.width-this.radius,this.height-this.radius,this.radius,0,Math.PI/2),t.lineTo(this.radius,this.height),t.arc(this.radius,this.height-this.radius,this.radius,Math.PI/2,Math.PI),t.lineTo(0,this.radius),t.arc(this.radius,this.radius,this.radius,Math.PI,Math.PI+Math.PI/2)}}}},figure:{ImageFigure:class extends q{constructor(t){super(t),null==t&&(t={}),this.targetTop=t.targetTop||0,this.targetLeft=t.targetLeft||0,this.targetWidth=t.targetWidth||0,this.targetHeight=t.targetHeight||0,t.texture&&(this.texture=t.texture)}drawSelf(t){null!=this.texture&&(0==this.targetWidth||0==this.targetHeight?t.drawImage(this.texture,0,0,this.width,this.height):t.drawImage(this.texture,this.targetLeft,this.targetTop,this.targetWidth,this.targetHeight,0,0,this.width,this.height))}},TileMap:class extends q{constructor(t){super(t=t||{}),this.row=t.row||1,this.column=t.column||1,this.data=t.data}createDummyFigures(){if(null!=this.data){let t=this.width/this.data.column;for(let e=0;e<this.row;e++)for(let i=0;i<this.column;i++){let s=this.data.datas[e][i];if(null!=s&&null!=s.physicsModel){let r=s.physicsModel.vertices;if(null!=r){let s=new gt({x:i*t,y:e*t,width:t,height:t,mass:1/0,visible:!1}),l=[],h=void 0,n=void 0,a=void 0,o=void 0;for(let e=0;e<r.length;e++){let i=r[e],s={x:i.x*t,y:i.y*t};h=null==h?s.x:Math.min(s.x,h),n=null==n?s.y:Math.min(s.y,n),a=null==a?s.x:Math.max(s.x,a),o=null==o?s.x:Math.max(s.y,o),l.push({x:i.x*t,y:i.y*t})}console.log(l),s.width=a-h,s.height=o-n;let u=new At;u.generateModel(l,{x:s.center.x,y:s.center.y},s.mass),s.physicsModel=u,this.addChild(s)}}}}}set data(t){if(this[Yt]=t,null==t){let t=this.childrenSize;for(let e=0;e<t;e++){let t=this.childrenSize;this.removeChild(this.getChild(t-1))}this.row=1,this.column=1}else this.row=t.row,this.column=t.column,this.createDummyFigures()}get data(){return this[Yt]}fitWidth(t){null==t&&(t=this.width),this.width=t;let e=t/this.column;this.height=e*this.row}fitHeight(t){null==t&&(t=this.height),this.height=t;let e=t/this.row;this.width=e*this.column}alignV(t){if("top"==t)this.y=0;else if("middle"==t){let t=this.getGraph();this.y=(t.height-this.height)/2}else if("bottom"==t){let t=this.getGraph();this.y=t.height-this.height}}alignH(t){if("left"==t)this.x=0;else if("middle"==t){let t=this.getGraph();this.x=(t.width-this.width)/2}else if("right"==t){let t=this.getGraph();this.x=t.width-this.width}}drawSelf(t){if(null==this.data)return;let e=this.width/this.data.column,i=t.getTexture(this.data.textureId);if(null!=i)for(let s=0;s<this.row;s++)for(let r=0;r<this.column;r++){let l=this.data.datas[s][r];null!=l&&null!=i&&t.drawImage(i,l.x,l.y,l.width,l.height,r*e,s*e,e,e)}}}},geometry:{SAT:yt},physics:{PhysicsModel:At},spirit:{TestRectSpirit:class extends gt{constructor(t){super(t),this.color=t.color||"white"}drawSelf(t){if(this.getTransformMatrix(),this.physicsModel){t.beginPath();let e=this.physicsModel.originalVertices;t.moveTo(e[0].x,e[0].y);for(let i=1;i<e.length;i++){let s=e[i];t.lineTo(s.x,s.y)}t.closePath(),t.fillStyle=this.color,t.fill()}else t.beginPath(),t.rect(0,0,this.width,this.height),t.fillStyle=this.color,t.fill()}},Spirit:class extends gt{get texture(){return this.defaultTexture}set texture(t){this.defaultTexture=t}get textureIndex(){return this._defaultTextureIndex}set textureIndex(t){this._defaultTextureIndex=t}constructor(t){super(t),null==t&&(t={}),this.targetTop=t.targetTop||0,this.targetLeft=t.targetLeft||0,this.targetWidth=t.targetWidth||0,this.targetHeight=t.targetHeight||0,t.texture&&(this._texture=t.texture,this.defaultTexture=t.texture),this._textureIndex=-1,this._defaultTextureIndex=-1,this.sheetAnimationMap={},this.currentAnimation={key:null,animation:new Dt(this)},null!=t.textureIndex&&(this._textureIndex=t.textureIndex,this._defaultTextureIndex=t.textureIndex)}addSheetAnimation(t){if(t){let e=t.key,i=t.start,s=t.end,r=t.time||500,l=t.loop||!1,h=t._texture;this.sheetAnimationMap[e]={start:i,end:s+.9,time:r,loop:l,texture:h}}}removeSheetAnimation(t){this.sheetAnimationMap[t]=void 0}get currentSheetAnimationPaused(){return this.currentAnimation.animation.paused}get currentSheetAnimationRunning(){return this.currentAnimation.animation.isRunning}get currentSheetAnimation(){return this.currentAnimation}playCurrentSheetAnimation(t){null!=this.currentAnimation.key&&this.playSheetAnimation(this.currentAnimation.key,t)}playSheetAnimation(t,e){if(this.currentAnimation.key===t){if(this.currentAnimation.animation.isRunning)return;if(this.currentAnimation.animation.paused)return void this.currentAnimation.animation.start()}let i=this.sheetAnimationMap[t];if(i){this.currentAnimation.key=t;let s=this.currentAnimation.animation;s.totalTime=i.time,i.loop&&(s.loop=-1),this._textureIndex=i.start,null!=s.texture&&(this._texture=s.texture),s.propertyChangeTo(i.end,"_textureIndex");let r=this;s.start({complete:function(){r._texture=r.defaultTexture,r._textureIndex=r._defaultTextureIndex,e&&e.complete&&e.complete()},stop:function(){r._texture=r.defaultTexture,r._textureIndex=r._defaultTextureIndex,e&&e.stop&&e.stop()}})}}pauseCurrentSheetAnimation(){this.currentAnimation.animation.isRunning&&this.currentAnimation.animation.pause()}stopCurrentSheetAnimation(){this.currentAnimation.animation.isRunning&&this.currentAnimation.animation.interrupt()}drawSelf(t){if(null==this._texture&&(this._texture=this.defaultTexture),null==this._texture)return;let e=this._texture;-1!=this._textureIndex&&(e=this._texture.splitedTextures[Math.floor(this._textureIndex)]),null!=e&&(0==this.targetWidth||0==this.targetHeight?t.drawImage(e,0,0,this.width,this.height):t.drawImage(e,this.targetLeft,this.targetTop,this.targetWidth,this.targetHeight,0,0,this.width,this.height))}}},World:class extends B{constructor(t,e){let i=(e=e||{}).gridRow||10,s=e.gridColumn||10;super(t),this.uniformGrid=new ft(i,s,this.width,this.height),this.showDebug=e.showDebug||!1,this.models=new c,this.p1={x:0,y:0},this.collisionTestedPairs={},this.refreshCount=0}contactTest(){for(let t=0;t<this.childrenSize;t++){let e=this.getChild(t);for(let t=0;t<this.childrenSize;t++){let i=this.getChild(t);e.overlap&&e.overlap(i)}}}modelAdded(t){let e=t.figure.getGraph(),i=t.property.child;e.addModel(i)}modelRemoved(t){let e=t.figure.getGraph(),i=t.property.child;e.removeModel(i)}afterFigureRefresh(t){}beforeFigureRefresh(t){let e=t.figure,i=e.physicsModel;if(null==i||!e.contactable)return;let s=e.getGraph();if(!e.isTransformChanged)return;s.uniformGrid&&s.uniformGrid.updateRegionsOfFigure(e);let r=e.relatedRegions;for(let t=0;t<r.length;t++){let h=r[t],a=s.uniformGrid.getRegion(h);for(let t=0;t<a.relatedFigures.length;t++){let r=a.relatedFigures.get(t);if(r==e)continue;if(null==r.physicsModel||!r.contactable)continue;if(l(r,e,s.collisionTestedPairs))continue;let h=s.collisionTestedPairs[e.id];null==h&&(h=s.collisionTestedPairs[r.id]);let o=void 0;if(null==h?(h={},s.collisionTestedPairs[e.id]=h,h[r.id]={warmNormalImpulse:0,warmTangentImpulse:0,tested:!0,refreshCount:s.refreshCount},o=h[r.id]):null==h[r.id]?(h[r.id]={warmNormalImpulse:0,warmTangentImpulse:0,tested:!0,refreshCount:s.refreshCount},o=h[r.id]):(o=h[r.id]).tested=!0,n.overlaps(e.getSelectBounds(),r.getSelectBounds())){let t=i,l=r.physicsModel;t.applyCurrentTransform(e.absoluteRotate,e.getRelativeTransformMatrix(s)),l.applyCurrentTransform(r.absoluteRotate,r.getRelativeTransformMatrix(s));let h=yt.collisionTest(t,l);if(h.collision){let i=o.refreshCount;++i>=1e4&&(i=0);let a=0,u=0;s.refreshCount,Math.max(t.elastic,l.elastic);let c=Math.min(t.friction,l.friction),d=Vt.solve(e,r,h.centerA,h.centerB,h.verticesA,h.verticesB,h.contactPoints,h.contactPlane,h.MTV.direction,0,c,h.MTV.minOverlap.value,1,.2,a,u);e.angularVelocity,d.w1,e.angularVelocity=d.w1,n.equals(e.angularVelocity,0)&&(e.angularVelocity=0),r.angularVelocity,d.w2,r.angularVelocity=d.w2,n.equals(r.angularVelocity,0)&&(r.angularVelocity=0),e.velocity.x,d.v1.x,e.velocity.y,d.v1.y,e.velocity.x=d.v1.x,n.equals(e.velocity.x,0)&&(e.velocity.x=0),e.velocity.y=d.v1.y,n.equals(e.velocity.y,0)&&(e.velocity.y=0),r.velocity.x,d.v2.x,r.velocity.y,d.v2.y,r.velocity.x=d.v2.x,n.equals(r.velocity.x,0)&&(r.velocity.x=0),r.velocity.y=d.v2.y,n.equals(r.velocity.y,0)&&(r.velocity.y=0),o.refreshCount=s.refreshCount,o.warmNormalImpulse=d.warmNormalImpulse,o.warmTangentImpulse=d.warmTangentImpulse}}}}function l(t,e,i){let s=i[t.id];if(null!=s){let t=s[e.id];if(null!=t)return t.tested}let r=i[e.id];if(null!=r){let e=r[t.id];if(null!=e)return e.tested}return!1}}removeModel(t){null!=t.physicsModel&&this.models.remove(t.physicsModel),t.removeEventListener(q.EVENT_ADD_CHILD,this.modelAdded),t.removeEventListener(q.EVENT_REMOVE_CHILD,this.modelRemoved),t.removeEventListener(q.EVENT_BEFORE_DRAW_SELF,this.beforeFigureRefresh);for(let e=0;e<t.childrenSize;e++){let i=t.getChild(e);this.removeModel(i)}}addModel(t){null!=t.physicsModel&&this.models.add(t.physicsModel);let e=t.getGraph();e&&null!=t.physicsModel&&t.contactable&&e.uniformGrid.updateRegionsOfFigure(t),t.addEventListener(q.EVENT_ADD_CHILD,this.modelAdded),t.addEventListener(q.EVENT_REMOVE_CHILD,this.modelRemoved),t.addEventListener(q.EVENT_BEFORE_DRAW_SELF,this.beforeFigureRefresh);for(let e=0;e<t.childrenSize;e++){let i=t.getChild(e);this.addModel(i)}}startWorld(){this.addModel(this);for(let t=0;t<this.children.length;t++){let e=this.getChild(t);e instanceof gt&&(e.isStaticFigure||e.startMove())}this.startLoopRefresh()}updateChildren(t){super.updateChildren(t),this.showDebug&&this._debug_drawPhysicsModel()}update(){for(let t in this.collisionTestedPairs){let e=this.collisionTestedPairs[t];for(let t in e)e[t].tested=!1}super.update(),this.refreshCount++,this.refreshCount>=1e4&&(this.refreshCount=0)}_debug_drawPhysicsModel(){function t(t,e){e.beginPath(),e.moveTo(t.vertices[0].x,t.vertices[0].y);for(let i=1;i<t.vertices.length;i++){let s=t.vertices[i];e.lineTo(s.x,s.y)}e.closePath(),e.stroke()}this.ctx.save(),this.ctx.strokeStyle="red",null!=this.m1&&t(this.m1,this.ctx),null!=this.m2&&t(this.m2,this.ctx),this.ctx.fillStyle="white",this.ctx.fillRect(this.p1.x,this.p1.y,5,5),this.ctx.restore()}},Figure:q,Tools:n},kt);e.default=kt}]).default});